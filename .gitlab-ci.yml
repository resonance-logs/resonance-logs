stages:
  - build

variables:
  RUST_TARGET: x86_64-pc-windows-msvc
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"

build-windows:
  stage: build
  # Run on the GitLab shared Windows runner
  tags:
    - shared-windows

  # Use a PowerShell-style script suitable for Windows shared runners.
  # We avoid installing Linux packages here since the shared Windows runner
  # already provides a Windows toolchain. Adjust or expand these steps
  # if your runner needs additional tools (e.g. NSIS, Rust, Node).
  script:
    - pwsh -Command "Write-Host 'Running CI on shared-windows runner'"
    - pwsh -Command "Set-Location -Path $env:CI_PROJECT_DIR; if (-not (Get-Command rustup -ErrorAction SilentlyContinue)) { Write-Host 'rustup not found â€” installing rustup'; Invoke-WebRequest -Uri 'https://win.rustup.rs' -OutFile \"$env:TEMP\\rustup-init.exe\"; & \"$env:TEMP\\rustup-init.exe\" -y } else { Write-Host 'rustup found' }; $rustupPath = Join-Path $env:USERPROFILE '.cargo\\bin\\rustup.exe'; if (Test-Path $rustupPath) { & $rustupPath default stable; & $rustupPath target add $env:RUST_TARGET } ; if (Get-Command bun -ErrorAction SilentlyContinue) { bun install --no-save } else { npm ci }"
    - pwsh -Command "npm run build"
    - pwsh -Command "npm run tauri build -- --target $env:RUST_TARGET"

  artifacts:
    paths:
      - src-tauri/target/release/*.exe
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 1 week

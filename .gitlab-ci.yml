stages:
  - build
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  npm_config_cache: $CI_PROJECT_DIR/.npm

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - .npm/
    - src-tauri/target/

build-tauri:
  stage: build
  tags:
    - saas-windows-medium-amd64
  before_script:
    # Install Node.js LTS
    - choco install nodejs-lts -y
    - refreshenv
    - node --version
    - npm --version

    # Install Rust stable
    - |
      if (!(Get-Command rustc -ErrorAction SilentlyContinue)) {
        Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
        .\rustup-init.exe -y --default-toolchain stable
        Remove-Item rustup-init.exe
      }
    - $env:PATH += ";$env:USERPROFILE\.cargo\bin"
    - rustc --version
    - cargo --version

  script:
    # Install frontend dependencies
    - npm install

    # Read changelog for release body
    - |
      $RELEASE_BODY = @(
        '# Changelog'
        (git log -1 --pretty=%B | Select-Object -Skip 1)
        ''
        if (Test-Path .github/workflows/RELEASE.md) {
          Get-Content .github/workflows/RELEASE.md
        }
      ) -join "`n"
      $RELEASE_BODY | Out-File -FilePath release_body.txt -Encoding utf8

    # Build Tauri app
    - |
      if ($CI_COMMIT_REF_NAME -eq 'release') {
        $env:TAURI_SIGNING_PRIVATE_KEY = $env:TAURI_SIGNING_PRIVATE_KEY
        npm run tauri build
      } else {
        npm run tauri build -- --debug
      }

  artifacts:
    name: "resonance-logs-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/
      - src-tauri/target/debug/bundle/
      - release_body.txt
    expire_in: 1 week

release-job:
  stage: release
  tags:
    - saas-windows-medium-amd64
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_REF_NAME == "release"
  needs:
    - build-tauri
  script:
    - echo "Creating release for $CI_COMMIT_REF_NAME"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: './release_body.txt'
    tag_name: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Windows Installer (NSIS)'
          url: '$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/file/src-tauri/target/release/bundle/nsis/'
        - name: 'Windows MSI'
          url: '$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/file/src-tauri/target/release/bundle/msi/'
